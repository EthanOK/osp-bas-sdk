import{EAS as e,SchemaRegistry as r}from"@ethereum-attestation-service/eas-sdk";import{VisibilityType as t,Long as n,RedundancyType as o,bytesFromBase64 as i,Client as s}from"@bnb-chain/greenfield-js-sdk";import{hashMessage as c,getAddress as a}from"ethers";import{ReedSolomon as u}from"@bnb-chain/reed-solomon";var d=function(r,t){new e(t).connect(r)},m=function(e,t,n){try{var o=new r(t);return o.connect(e),Promise.resolve(o.register({schema:n.schema,resolverAddress:n.resolverAddress,revocable:n.revocable})).then(function(e){return Promise.resolve(e.wait())})}catch(e){return Promise.reject(e)}},l=function(e,t,n){try{var o=new r(t);return o.connect(e),Promise.resolve(o.getSchema({uid:n}))}catch(e){return Promise.reject(e)}},f=function(e,r,t){try{return r.connect(e),Promise.resolve(r.getOffchain()).then(function(r){var n=Math.floor(Date.now()/1e3);return Promise.resolve(r.signOffchainAttestation({recipient:t.recipient,expirationTime:BigInt(0),time:BigInt(n),revocable:!0,version:1,nonce:BigInt(0),schema:t.schemaUID,refUID:t.refUID,data:t.encodedData},e)).then(function(e){return JSON.stringify(e,function(e,r){return"bigint"==typeof r?Number(r).toString():r})})})}catch(e){return Promise.reject(e)}},h=function(e){return"bas-"+c(a(e)).substring(2,42)},v=function(e){try{return Promise.resolve(e.sp.getStorageProviders()).then(function(e){return(null!=e?e:[]).filter(function(e){return e.endpoint.includes("nodereal")})})}catch(e){return Promise.reject(e)}},p=function(e){return Promise.resolve(v(e)).then(function(e){return e.map(function(e){var r;return{address:e.operatorAddress,endpoint:e.endpoint,name:null==(r=e.description)?void 0:r.moniker}})})},g=function(e){return Promise.resolve(v(e)).then(function(e){var r,t=Math.floor(Math.random()*e.length),n=[].concat(e.slice(0,t),e.slice(t+1)).map(function(e){return e.operatorAddress});return{id:e[t].id||0,endpoint:e[t].endpoint,primarySpAddress:null==(r=e[t])?void 0:r.operatorAddress,sealAddress:e[t].sealAddress,secondarySpAddresses:n}})};function b(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var P=new u,y=/*#__PURE__*/function(){function e(e,r,t){this.client=void 0,this.address=null,this.client=s.create(e,r),this.address=t}var r=e.prototype;return r.createBucket=function(e,r){try{var o=this;return Promise.resolve(g(o.client)).then(function(i){function s(){var s=b(function(){return Promise.resolve(o.client.bucket.createBucket({bucketName:e,creator:o.address,visibility:t.VISIBILITY_TYPE_PUBLIC_READ,chargedReadQuota:n.fromString("0"),paymentAddress:o.address,primarySpAddress:i.primarySpAddress})).then(function(e){return Promise.resolve(e.simulate({denom:"BNB"})).then(function(t){return Promise.resolve(e.broadcast({denom:"BNB",gasLimit:Number(null==t?void 0:t.gasLimit),gasPrice:(null==t?void 0:t.gasPrice)||"5000000000",payer:o.address,granter:"",privateKey:r})).then(function(e){console.log("transactionHash",e.transactionHash)})})})},function(e){c||console.log(e)});return s&&s.then?s.then(function(){return c}):c}r.startsWith("0x")||(r="0x"+r);var c=!1,a=b(function(){return Promise.resolve(o.client.bucket.getBucketMeta({bucketName:e})).then(function(e){console.log("bucketMeta",e),c=!0})},function(){});return a&&a.then?a.then(s):s()})}catch(e){return Promise.reject(e)}},r.createObject=function(e,r,s,c){void 0===c&&(c=!1);try{var a=this;console.log("started"),s.startsWith("0x")||(s="0x"+s);var u=JSON.parse(r),d=u.message.schema+"."+u.uid,m=Buffer.from(r),l=P.encode(Uint8Array.from(m));return Promise.resolve(a.client.object.createObject({bucketName:e,objectName:d,creator:a.address,visibility:c?t.VISIBILITY_TYPE_PRIVATE:t.VISIBILITY_TYPE_PUBLIC_READ,contentType:"json",redundancyType:o.REDUNDANCY_EC_TYPE,payloadSize:n.fromInt(m.byteLength),expectChecksums:l.map(function(e){return i(e)})})).then(function(r){return Promise.resolve(r.simulate({denom:"BNB"})).then(function(t){return Promise.resolve(r.broadcast({denom:"BNB",gasLimit:Number(t.gasLimit),gasPrice:t.gasPrice,payer:a.address,granter:"",privateKey:s})).then(function(r){var t=r.transactionHash;return console.log("create object success",t),Promise.resolve(a.client.object.uploadObject({bucketName:e,objectName:d,body:I(d,m),txnHash:t},{type:"ECDSA",privateKey:s})).then(function(e){return 0===e.code&&console.log("upload object success",e),t})})})})}catch(e){return Promise.reject(e)}},e}();function I(e,r){return{name:e,type:"",size:r.byteLength,content:r}}export{y as GreenFieldClientTS,f as createAttestOffChain,h as encodeAddrToBucketName,p as getAllSps,l as getSchemaByUID,v as getSps,d as initEAS,m as registerSchema,g as selectSp};
//# sourceMappingURL=index.module.js.map
